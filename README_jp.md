# Spresense IMU 自己位置推定

[English](./README.md) | 日本語


このリポジトリは、Spresenseボードの内蔵IMU（慣性計測ユニット）を利用してセンサによる自己位置推定を行うArduino IDE向けプロジェクトを収録しています。本プロジェクトでは、キャリブレーション、フィルタ処理、姿勢推定などのセンサフュージョン技術を実装し、加速度、速度、位置の推定を行います。

## 概要

本プログラムは、Spresense内蔵のIMUセンサから加速度、角速度、温度のデータを取得し、以下の処理を行います。

- **キャリブレーションと初期化:** 一定期間のセンサデータを平均化し、初期のバイアスおよび姿勢（クォータニオン）を算出します。
- **フィルタリング:** 因果型ガウスフィルタを適用し、センサデータのノイズを低減します。
- **姿勢推定:** 加速度計とジャイロセンサのデータを融合し、Madgwickフィルタに基づくクォータニオン更新（Runge–Kutta法による数値積分）を行います。
- **ゼロ速度補正:** センサが静止状態にあると判断された場合、速度のドリフトを補正するためゼロ速度更新を実施します。
- **位置推定:** 補正後の加速度から速度および位置を単純オイラー積分により更新します。

## 特徴

- **IMUデータ取得:** Spresense内蔵の加速度、角速度、温度データを読み取ります。
- **センサフュージョン:** キャリブレーションを通じて加速度計とジャイロセンサのデータを統合し、安定した姿勢推定を実現します。
- **クォータニオンによる姿勢推定:** クォータニオンの微分方程式とRK4法を用いて、滑らかな姿勢更新を行います。
- **ガウスフィルタリング:** 因果型ガウスカーネルを用いて、センサデータの高周波ノイズを除去します。
- **ゼロ速度補正:** 静止状態検出に基づき、速度の累積誤差（ドリフト）を補正します。
- **リアルタイムデータ出力:** シリアル通信により、タイムスタンプ、センサデータ、推定加速度、姿勢（クォータニオン）、速度、位置の情報を出力します。

## ハードウェア要件

- **Sony Spresense ボード:** 内蔵IMUを有するSpresenseボードが必要です。
- **IMUセンサ:** 本プロジェクトでは、CXD5602PWBIMUセンサを利用します。

## ソフトウェア要件

- **Arduino IDE:** Spresense向けArduinoライブラリがインストールされている必要があります。
- **Spresense SDK:** ボードへの書き込みおよびビルドに必要なSDKを使用します。

## はじめに

### インストール

1. **リポジトリのクローン:**

   ```bash
   git clone https://github.com/hijimasa/cxd5602pwbimu_localizer_arduino.git
   cd cxd5602pwbimu_localizer_arduino
   ```

2. **Arduino IDEでプロジェクトを開く:**

   Arduino IDEでプロジェクトを開き、Spresenseボードおよび関連ライブラリが正しくインストールされていることを確認してください。

3. **コンパイル & アップロード:**

   コードをビルドし、Spresenseボードへ書き込みます。書き込み完了後、自動的にIMUのデータ取得と処理が開始されます。

### アプリケーションの実行

- 書き込み後、シリアルモニタ（115200bps）を起動し、出力されるデータを確認してください。
- 定期的にフォーマットされたセンサデータ（タイムスタンプ、推定加速度、クォータニオン、速度、位置など）が出力されます。

## コード構成とアルゴリズム詳細

### 初期化とキャリブレーション

- **初期化関数 (`imu_data_initialize`):**  
  一定期間（`MESUREMENT_FREQUENCY`サンプル）のデータを平均化して、加速度計とジャイロセンサの初期バイアスおよび姿勢（クォータニオン）を計算します。

### データ処理

- **ガウスフィルタ:**  
  過去のデータに対して因果型ガウスフィルタを適用し、加速度と角速度のノイズを低減します。
  
- **姿勢更新:**  
  ジャイロセンサの読み取り値に基づき、RK4法を用いてクォータニオンを更新します。これにより、滑らかな回転推定が実現されます。

- **Madgwickフィルタ:**  
  加速度計とジャイロセンサのデータを融合し、重力方向の誤差を補正するためのMadgwickアルゴリズムを適用します。

- **ゼロ速度補正:**  
  計算された速度が所定の閾値以下の場合、ゼロ速度補正により速度をリセットし、ドリフトを防止します。

### 速度・位置の積分更新

- **速度および位置の更新:**  
  重力補正後の加速度を元に、単純なオイラー積分で速度と位置を更新します。

## Contributing

貢献は大歓迎です！リポジトリをフォークして、プルリクエストをお送りください。大きな変更を加える場合は、事前にIssueを立てて議論いただけると助かります。

## ライセンス

このプロジェクトはMITライセンスの下で配布されています。詳細は`LICENSE`ファイルをご確認ください。

---

このREADMEは、プロジェクトの概要や主要な処理内容、使用方法について説明しています。ご不明点やご質問があれば、Issueを通じてお気軽にお問い合わせください。
