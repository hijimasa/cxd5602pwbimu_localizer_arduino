# Spresense IMU 自己位置推定

[English](./README.md) | 日本語


このリポジトリは、Spresenseボードの内蔵IMU（慣性計測ユニット）を利用してセンサによる自己位置推定を行うArduino IDE向けプロジェクトを収録しています。本プロジェクトでは、**Fusionライブラリ**を使用したセンサフュージョン技術により、キャリブレーション、フィルタ処理、姿勢推定を実装し、加速度、速度、位置の推定を行います。

## 概要

本プログラムは、Spresense内蔵のIMUセンサから加速度、角速度、温度のデータを取得し、以下の処理を行います。

- **キャリブレーションと初期化:** 一定期間のセンサデータを平均化し、初期のバイアスおよび姿勢（クォータニオン）を算出します。
- **フィルタリング:** 因果型ガウスフィルタを適用し、センサデータのノイズを低減します。
- **姿勢推定:** **Fusion AHRS (Attitude and Heading Reference System)** ライブラリを使用して加速度計とジャイロセンサのデータを融合し、動作中の加速度計拒否機能を備えた堅牢なクォータニオンベースの姿勢推定を実現します。
- **ジャイロバイアス補償:** Fusionライブラリの FusionOffset アルゴリズムを使用して、実行時のジャイロオフセット補正を実施します。
- **加速度バイアス補正:** 静止期間中に加速度バイアスを継続的に更新する適応バイアス補正機構を実装しています。
- **ゼロ速度更新 (ZUPT):** 加速度とジャイロの大きさの閾値に基づいて静止状態を検出し、速度のドリフトをリセットするゼロ速度更新を実施します。
- **位置推定:** 補正後の加速度から速度および位置を台形積分により更新します。

## 特徴

- **IMUデータ取得:** Spresense内蔵の加速度、角速度、温度データを読み取ります。
- **Fusion AHRS統合:** Fusionライブラリを活用した、加速度計拒否機能と自動重力除去を備えた堅牢なセンサフュージョンを実現します。
- **クォータニオンによる姿勢推定:** Fusion AHRSアルゴリズムを使用した滑らかな姿勢更新を実現します。
- **ガウスフィルタリング:** 因果型ガウスカーネルを用いて、センサデータの高周波ノイズを除去します。
- **適応バイアス補正:** 静止期間中に加速度バイアスを継続的に更新し、温度ドリフトを補償します。
- **ゼロ速度更新:** 静止状態検出時にZUPT補正を適用し、速度ドリフトの蓄積を防止します。
- **台形積分:** 単純なオイラー積分よりも精度の高い台形法を使用して速度と位置を更新します。
- **リアルタイムデータ出力:** シリアル通信により、タイムスタンプ、センサデータ、推定加速度、姿勢（クォータニオン）、速度、位置の情報を出力します。

## ハードウェア要件

- **Sony Spresense ボード:** 内蔵IMUを有するSpresenseボードが必要です。
- **IMUセンサ:** 本プロジェクトでは、CXD5602PWBIMUセンサを利用します。

## ソフトウェア要件

- **Arduino IDE:** Spresense向けArduinoライブラリがインストールされている必要があります。
- **Spresense SDK:** ボードへの書き込みおよびビルドに必要なSDKを使用します。

## はじめに

### インストール

1. **リポジトリのクローン:**

   ```bash
   git clone https://github.com/hijimasa/cxd5602pwbimu_localizer_arduino.git
   cd cxd5602pwbimu_localizer_arduino
   git submodule update --init
   ```

2. **Arduino IDEでプロジェクトを開く:**

   Arduino IDEでプロジェクトを開き、Spresenseボードおよび関連ライブラリが正しくインストールされていることを確認してください。

3. **コンパイル & アップロード:**

   コードをビルドし、Spresenseボードへ書き込みます。書き込み完了後、自動的にIMUのデータ取得と処理が開始されます。

### アプリケーションの実行

- 書き込み後、シリアルモニタ（115200bps）を起動し、出力されるデータを確認してください。
- 定期的にフォーマットされたセンサデータ（タイムスタンプ、推定加速度、クォータニオン、速度、位置など）が出力されます。

## コード構成とアルゴリズム詳細

### 初期化とキャリブレーション

- **初期化関数 (`imu_data_initialize`):**
  一定期間（`MESUREMENT_FREQUENCY`サンプル）のデータを平均化して、加速度計とジャイロセンサの初期バイアスおよび姿勢（クォータニオン）を計算します。

- **加速度バイアス学習 (`initialize_acceleration_bias`):**
  セットアップ段階で、システムは5秒間のIMUデータ（9600サンプル）を収集し、Fusion AHRSライブラリを使用して初期加速度バイアスを学習します。これにより、センサの製造ばらつきや温度依存オフセットを補償します。

### データ処理

- **ガウスフィルタ:**
  過去のデータに対してシグマ = LIST_SIZE/8.0 の因果型ガウスフィルタを適用し、加速度と角速度のノイズを低減します。

- **Fusion AHRSアルゴリズム:**
  Fusionライブラリは、以下を処理する包括的なAHRSソリューションを提供します。
  - ジャイロ積分によるクォータニオン更新
  - 動作中の加速度計拒否を伴う加速度計補正（閾値: 10度）
  - 自動重力ベクトル追跡と除去
  - 座標系変換（北西上方向規則）
  - センサ飽和後のリカバリメカニズム（5秒トリガー期間）

- **ジャイロオフセット補正:**
  `FusionOffset` アルゴリズムが実行時にジャイロバイアスを継続的に推定・補正します。

- **適応加速度バイアス更新:**
  静止期間（ZUPTにより検出）中に、加速度バイアスを指数移動平均（学習率: 0.1%）を使用して継続的に更新し、温度ドリフトを補償します。

- **ゼロ速度更新 (ZUPT):**
  改良されたZUPTアルゴリズムは、以下に基づいて静止状態を検出します:
  - 加速度の大きさ閾値: < 0.15 m/s²
  - ジャイロの大きさ閾値: < 0.015 rad/s（≈ 0.86°/s）
  - 継続時間要件: 0.1秒（192サンプル）

  静止状態が検出されると、速度がゼロにリセットされ、加速度バイアスが更新されます。

### 速度・位置の積分更新

- **速度および位置の更新:**
  重力とバイアスを補正した後、加速度を**台形法**を使用して時間積分し、速度と位置を更新します。これにより、単純なオイラー積分と比較してより高い精度が得られます。

## Contributing

貢献は大歓迎です！リポジトリをフォークして、プルリクエストをお送りください。大きな変更を加える場合は、事前にIssueを立てて議論いただけると助かります。

## ライセンス

このプロジェクトはMITライセンスの下で配布されています。詳細は`LICENSE`ファイルをご確認ください。

---

このREADMEは、プロジェクトの概要や主要な処理内容、使用方法について説明しています。ご不明点やご質問があれば、Issueを通じてお気軽にお問い合わせください。
