# Spresense IMU 自己位置推定

[English](./README.md) | 日本語

このリポジトリは、Spresenseボードの内蔵IMU（慣性計測ユニット）を利用してセンサによる自己位置推定を行うArduino IDE向けプロジェクトを収録しています。本プロジェクトでは、**Spresenseのマルチコアアーキテクチャ**（6コア）を活用した高性能並列処理を実現し、**Fusionライブラリ**を使用したセンサフュージョン技術により、キャリブレーション、フィルタ処理、姿勢推定を実装しています。

## 概要

本システムは、1920HzでIMUの生データ（加速度、角速度、温度）を読み取り、マルチコアパイプラインで処理します：

- **MainCore:** IMUデータ取得、初期キャリブレーション、データ配信
- **SubCore1:** ノイズ低減のためのガウシアンフィルタ
- **SubCore2:** Fusionライブラリを使用したAHRS（姿勢方位基準システム）
- **SubCore3:** ゼロ速度更新（ZUPT）検出とバイアス推定
- **SubCore4:** 速度・位置の積分

## アーキテクチャ

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  MainCore   │───▶│  SubCore1   │───▶│  SubCore2   │───▶│  SubCore3   │───▶│  SubCore4   │
│  IMU読取    │    │ ガウシアン  │    │  Fusion     │    │    ZUPT     │    │    位置     │
│  1920Hz     │    │  フィルタ   │    │    AHRS     │    │   バイアス  │    │    積分     │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └──────┬──────┘
                                                                                    │
                                                                                    ▼
                                                                           シリアル出力 (30Hz)
```

## 特徴

- **高速IMUデータ取得:** IMUの性能を最大限に活用した1920Hzサンプリング
- **マルチコア並列処理:** 5つのコアに計算を分散させリアルタイム処理を実現
- **Fusion AHRS統合:** 加速度計拒否機能と自動重力除去を備えた堅牢なセンサフュージョン
- **ガウシアンフィルタリング:** ノイズ低減のための因果型ガウスフィルタ
- **分散ベースZUPT検出:** 絶対値閾値ではなく信号の分散を使用して静止状態を検出。センサバイアスがあっても正確に検出可能
- **適応バイアス補正:** 静止期間中に加速度バイアスを継続的に更新
- **台形積分:** 速度・位置推定の精度向上

## ハードウェア要件

- **Sony Spresense メインボード**（CXD5602プロセッサ搭載）
- **Spresense IMUアドオンボード**（CXD5602PWBIMU）

## ソフトウェア要件

- **Arduino IDE**（1.8.x または 2.x）
- **Spresense Arduino ボードパッケージ**（3.0.0以降）
- **Spresense SDK**（ボードサポート用）

## はじめに

### インストール

1. **リポジトリのクローン:**

   ```bash
   git clone https://github.com/hijimasa/cxd5602pwbimu_localizer_arduino.git
   cd cxd5602pwbimu_localizer_arduino
   git submodule update --init
   ```

2. **Spresense Arduino ボードパッケージのインストール:**

   - Arduino IDEを開く
   - **ファイル** > **基本設定** を選択
   - 「追加のボードマネージャのURL」に以下を追加：
     ```
     https://github.com/sonydevworld/spresense-arduino-compatible/releases/download/generic/package_spresense_index.json
     ```
   - **ツール** > **ボード** > **ボードマネージャ** を選択
   - 「Spresense」を検索してパッケージをインストール

### ビルドとアップロード（マルチコア）

本プロジェクトは複数のコアを使用するため、Arduino IDEで各コアを個別にコンパイル・アップロードする必要があります。

#### ステップ1: 先にSubCoreをアップロード

SubCoreはMainCoreより**先に**アップロードする必要があります。

1. **SubCore1（ガウシアンフィルタ）:**
   - Arduino IDEで `SubCore1/SubCore1.ino` を開く
   - **ツール** > **Core** > **"SubCore 1"** を選択
   - **マイコンボードに書き込む**をクリック（またはCtrl+U）

2. **SubCore2（AHRS）:**
   - Arduino IDEで `SubCore2/SubCore2.ino` を開く
   - **ツール** > **Core** > **"SubCore 2"** を選択
   - **マイコンボードに書き込む**をクリック

3. **SubCore3（ZUPT）:**
   - Arduino IDEで `SubCore3/SubCore3.ino` を開く
   - **ツール** > **Core** > **"SubCore 3"** を選択
   - **マイコンボードに書き込む**をクリック

4. **SubCore4（位置積分）:**
   - Arduino IDEで `SubCore4/SubCore4.ino` を開く
   - **ツール** > **Core** > **"SubCore 4"** を選択
   - **マイコンボードに書き込む**をクリック

#### ステップ2: 最後にMainCoreをアップロード

1. Arduino IDEで `cxd5602pwbimu_localizer_arduino.ino` を開く
2. **ツール** > **Core** > **"MainCore"** を選択
3. **マイコンボードに書き込む**をクリック

### アプリケーションの実行

1. すべてのコアをアップロード後、シリアルモニタを開く
2. ボーレートを **115200** に設定
3. システムが自動キャリブレーションを実行します：
   - **5秒間:** 初期姿勢キャリブレーション（センサを静止させてください）
   - **10秒間:** 加速度バイアス学習（センサを静止させてください）
4. キャリブレーション後、30Hzで位置データが出力されます

### 出力フォーマット

シリアル出力はカンマ区切りの値を含みます：
```
タイムスタンプ, qw, qx, qy, qz, vx, vy, vz, px, py, pz, ax, ay, az, gx, gy, gz, 温度, 静止フラグ
```

## プロジェクト構成

```
cxd5602pwbimu_localizer_arduino/
├── cxd5602pwbimu_localizer_arduino.ino  # MainCore: IMU取得 & キャリブレーション
├── shared_types.h                        # コア間通信用共有データ構造体
├── SubCore1/
│   └── SubCore1.ino                      # ガウシアンフィルタ処理
├── SubCore2/
│   ├── SubCore2.ino                      # Fusion AHRS処理
│   └── src/Fusion/                       # Fusionライブラリ
├── SubCore3/
│   └── SubCore3.ino                      # ZUPT検出 & バイアス推定
├── SubCore4/
│   └── SubCore4.ino                      # 速度・位置積分
├── SubCore5/
│   └── SubCore5.ino                      # （将来使用予定）
└── src/Fusion/                           # MainCore用Fusionライブラリ
```

## アルゴリズム詳細

### 初期化とキャリブレーション

1. **姿勢キャリブレーション（5秒）:**
   - 加速度計とジャイロセンサの読み取り値を平均化
   - 重力と地球自転ベクトルから初期クォータニオンを計算

2. **加速度バイアス学習（10秒）:**
   - Fusion AHRSを使用して重力除去済み加速度を計算
   - 測定値と期待される重力ベクトルを比較してセンサバイアスを学習

### データ処理パイプライン

1. **ガウシアンフィルタ（SubCore1）:**
   - σ = LIST_SIZE/8.0 の因果型ガウスフィルタ
   - 信号のダイナミクスを保持しながら高周波ノイズを低減

2. **AHRS処理（SubCore2）:**
   - Fusionライブラリによるクォータニオンベースの姿勢推定
   - 動的動作中の加速度計拒否（閾値: 10°）
   - 地球座標系での自動重力除去
   - 座標変換前にセンサ座標系でバイアス補正を適用

3. **ZUPT検出（SubCore3）:**
   - **分散ベース検出:** 絶対値ではなく信号の分散を使用
   - 閾値: 加速度分散 < 0.004 (m/s²)², ジャイロ分散 < 0.00006 (rad/s)²
   - ウィンドウサイズ: 16サンプル、96サンプル（0.05秒）の確認期間
   - 利点: センサバイアスオフセットがあっても正確に動作

4. **位置積分（SubCore4）:**
   - 速度と位置の台形積分
   - ZUPT補正により静止期間中に速度をゼロにリセット

## 設定

`shared_types.h` の主要パラメータ：

| パラメータ | 値 | 説明 |
|-----------|------|------|
| `MESUREMENT_FREQUENCY` | 1920 Hz | IMUサンプリングレート |
| `GRAVITY_AMOUNT` | 9.7975 m/s² | 局所重力（東京） |
| `FUSION_AHRS_GAIN` | 0.1 | AHRSフィルタゲイン |
| `FUSION_ACCEL_REJECTION` | 10.0° | 加速度計拒否閾値 |

## トラブルシューティング

### よくある問題

1. **SubCoreが起動しない:**
   - すべてのSubCoreがアップロードされていることを確認

2. **静止中の位置ドリフト:**
   - 初期キャリブレーション中はセンサを完全に静止させてください
   - 分散ベースZUPTが残留バイアスを処理します

3. **コンパイルエラー:**
   - Spresenseボードパッケージが正しくインストールされていることを確認
   - ツールメニューで正しいコアが選択されていることを確認

## Contributing

貢献は大歓迎です！リポジトリをフォークして、プルリクエストをお送りください。大きな変更を加える場合は、事前にIssueを立てて議論いただけると助かります。

## ライセンス

このプロジェクトはMITライセンスの下で配布されています。詳細は `LICENSE` ファイルをご確認ください。

---

ご質問や問題がございましたら、GitHub Issueを作成するか、リポジトリ管理者にお問い合わせください。
